<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>APYCHAT</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background-color: #f4f6fa;
    }

    .chat-container {
      max-width: 800px;
      margin: 40px auto;
      background-color: white;
      border-radius: 15px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
      display: flex;
      flex-direction: column;
      height: 90vh;
    }

    .chat-header {
      padding: 15px 20px;
      border-bottom: 1px solid #e1e1e1;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .chat-header .name {
      font-weight: 600;
    }

    .chat-body {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }

    .message {
      max-width: 75%;
      padding: 12px 18px;
      margin-bottom: 10px;
      border-radius: 15px;
      font-size: 14px;
      word-break: break-word;
    }

    .message.user {
      background-color: #005eff;
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 0;
    }

    .message.bot {
      background-color: #e8f0fe;
      align-self: flex-start;
      border-bottom-left-radius: 0;
    }

    .chat-footer {
      padding: 15px 20px;
      border-top: 1px solid #e1e1e1;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .chat-footer input,
    .chat-footer textarea {
      flex: 1;
      border-radius: 20px;
      border: 1px solid #ccc;
      padding: 10px 15px;
      resize: none;
    }

    .chat-footer button {
      border: none;
      background: #005eff;
      color: white;
      padding: 10px 15px;
      border-radius: 50%;
    }

    .env-selection {
      margin: 10px 0;
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>

<div class="chat-container d-flex flex-column">
  <!-- Header -->
  <div class="chat-header">
    <div class="d-flex align-items-center gap-2">
      <img src="https://i.pravatar.cc/40" class="rounded-circle" width="40" />
      <div>
        <div class="name">APYCHAT</div>
        <div class="text-success small">Online</div>
      </div>
    </div>
    <div>üéôÔ∏èüí¨</div>
  </div>

  <!-- Environment Selector -->
  <div class="env-selection px-3 pt-2">
    <label><input type="radio" name="env" value="production" checked> Produ√ß√£o</label>
    <label class="ms-3"><input type="radio" name="env" value="test"> Teste</label>
  </div>

  <!-- Chat Body -->
  <div class="chat-body d-flex flex-column" id="chatHistory"></div>

  <!-- Chat Footer -->
  <div class="chat-footer">
    <form id="chatFormText" class="w-100 d-flex gap-2">
      <textarea class="form-control" name="message" rows="1" placeholder="Digite aqui..." required></textarea>
      <button type="submit" title="Enviar Texto">‚û§</button>
    </form>
    <form id="chatFormAudio" class="w-100 d-flex gap-2">
      <input type="file" name="file" accept="audio/*" class="form-control" />
      <button type="submit" title="Enviar √Åudio">üéß</button>
    </form>
    <button id="recordButton" class="btn btn-outline-secondary w-100">üé§ Gravar √Åudio</button>
    <audio id="player" controls class="w-100 mt-2 hidden"></audio>
  </div>
</div>

<script>
  // Adiciona mensagens no chat
  function addMessageToHistory(text, isUser = false) {
    const chatHistory = document.getElementById('chatHistory');
    const messageDiv = document.createElement('div');
    messageDiv.classList.add('message', isUser ? 'user' : 'bot');
    messageDiv.innerHTML = text;
    chatHistory.appendChild(messageDiv);
    chatHistory.scrollTop = chatHistory.scrollHeight;
  }

  // Enviar Texto
  document.getElementById('chatFormText').addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = new FormData(e.target);
    const envValue = document.querySelector('input[name="env"]:checked').value;
    form.append("env", envValue);

    const userMessage = form.get("message");
    addMessageToHistory(userMessage, true);

    const res = await fetch('/chat/text', { method: 'POST', body: form });
    const data = await res.json();
    const botResponse = data?.response?.text || (typeof data?.response === 'string' ? data.response : "Desculpe, n√£o consegui entender.");
    addMessageToHistory(botResponse, false);

    e.target.reset();
  });

  // Enviar √Åudio (upload manual)
document.getElementById('chatFormAudio').addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = new FormData(e.target);
    const envValue = document.querySelector('input[name="env"]:checked').value;
    form.append("env", envValue);

    const res = await fetch('/chat/audio', { method: 'POST', body: form });
    const data = await res.json();

    if (data.audio_url) {
        // Mostra o √°udio como mensagem do usu√°rio
        addMessageToHistory(`<audio controls><source src="${data.audio_url}" type="audio/ogg"></audio>`, true);

        // Mostra a resposta do bot - agora tratando diretamente data.response
        const botResponse = data.response || "Desculpe, n√£o consegui entender.";
        addMessageToHistory(botResponse, false);
    } else {
        addMessageToHistory("Erro ao enviar √°udio.", false);
    }
});



  // Grava√ß√£o de √Åudio
  let mediaRecorder;
  let audioChunks = [];

  const recordButton = document.getElementById("recordButton");
  const player = document.getElementById("player");

  recordButton.addEventListener("click", async () => {
    if (mediaRecorder && mediaRecorder.state === "recording") {
      mediaRecorder.stop();
      recordButton.innerText = "üé§ Gravar √Åudio";
      return;
    }

    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);

    mediaRecorder.ondataavailable = e => {
      audioChunks.push(e.data);
    };

    mediaRecorder.onstop = async () => {
      const audioBlob = new Blob(audioChunks, { type: "audio/ogg" });
      audioChunks = [];

      const audioUrl = URL.createObjectURL(audioBlob);
      player.src = audioUrl;
      player.classList.remove("hidden");

      const formData = new FormData();
      formData.append("file", audioBlob, "gravacao.ogg");

      const envValue = document.querySelector('input[name="env"]:checked').value;
      formData.append("env", envValue);

      const res = await fetch("/chat/audio", {
        method: "POST",
        body: formData
      });

      const data = await res.json();
      if (data.audio_url) {
        addMessageToHistory(`<audio controls><source src="${data.audio_url}" type="audio/ogg"></audio>`, false);
      } else {
        addMessageToHistory("Erro ao enviar √°udio gravado.", false);
      }
    };

    mediaRecorder.start();
    recordButton.innerText = "‚èπÔ∏è Parar Grava√ß√£o";
  });
</script>

</body>
</html>
